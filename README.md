TCPプロトコルでチャットルーム作成後、UDPプロトコルでクライアント間のチャットを可能にするソフトウェア。

機能要件

チャットルームの作成と接続（TCP）

カスタム TCP プロトコルを作成し、クライアントとサーバがチャットルームの作成と接続のために通信できるようにします。TCP は、メッセージの受信と順序が保証されるため、信頼性が高いです。以下は、チャットルームプロトコル（TCRP）と呼ぶカスタムプロトコルです。

ヘッダー（32 バイト）: RoomNameSize（1 バイト） | Operation（1 バイト） | State（1 バイト） | OperationPayloadSize（29 バイト）

ボディ: 最初の RoomNameSize バイトがルーム名で、その後に OperationPayloadSize バイトが続きます。ルーム名の最大バイト数は 28 バイトであり、OperationPayloadSize の最大バイト数は 229 バイトです。

RoomNames は UTF-8 でエンコード/デコードされます。OperationPayload は、操作と状態に応じて異なる方法でデコードされる可能性があります（整数、文字列、JSON ファイルなど）

新しいチャットルームを作成する場合、操作コードは 1 です。0 はリクエスト、1 は準拠、2 は完了です。TCP は完全なトランザクションを保証するために使用されます。

サーバの初期化（0）: クライアントが新しいチャットルームを作成するリクエストを送信します。ペイロードには希望するユーザー名が含まれます。

リクエストの応答（1）: サーバはステータスコードを含むペイロードで即座に応答します。

リクエストの完了（2）: サーバは特定の生成されたユニークなトークンをクライアントに送り、このトークンにユーザー名を割り当てます。このトークンはクライアントをチャットルームのホストとして識別します。トークンは最大 255 バイトです。

新しいチャットルームに参加しようとするとき、操作コードは 2 です。状態は作成時と同様で、クライアントも生成されたトークンを受け取りますが、ホストではありません。

チャットルームごとに、サーバは許可されたリストトークンのリストを追跡する必要があります。ユーザーがそのトークンで参加すると、トークンの所有者として設定されます。メッセージがチャットルーム内の他のすべての人にリレーされるためには、トークンと IP アドレスが一致しなければなりません。

チャットルームの作成またはチャットルームへの参加が完了すると、TCP コネクションは終了します。クライアントは自動的に UDP でサーバに接続します。


ルームでのチャット（UDP）

チャットルームはホストが存在する限り有効です。ホストが退出すると、チャットルームは自動的に閉じられます。

チャットルームに参加するには、専用の許可トークンが必要です。このトークンは参加者の IP アドレスと一致する必要があります。

クライアントとサーバ間でのメッセージ交換は、すべて UDP プロトコルを使用して行われます。

クライアントがサーバに送信するパケットは、最大 4096 バイトのメッセージとなります。そのうちの最初の 2 バイトは、ルーム名とトークンのバイトサイズを示しています。
ヘッダー: RoomNameSize（1 バイト）| TokenSize（1 バイト）
ボディ: 最初の RoomNameSize バイトはルーム名、次の TokenSize バイトはトークン文字列、そしてその残りが実際のメッセージです。

クライアントはサーバから最大で 4094 バイトのパケットを受信できます。これはメッセージのみで、ヘッダーは含まれません。

クライアントがリレーシステムから削除された場合、そのトークンもサーバから削除されます。サーバは切断メッセージを該当のクライアントに転送します。その後、クライアントは再度チャットルームに参加する必要があります。
メッセージ送信時、サーバとクライアントは一度に最大で 4096 バイトのメッセージを処理します。これは、クライアントが送信できるメッセージの最大サイズです。同じく、最大 4096 バイトのメッセージが他の全クライアントに転送されます。
セッションが開始される際には、クライアントはユーザーにユーザー名を入力させます。

メッセージの送信プロトコルは比較的シンプルです。メッセージの最初の 1 バイト、usernamelen は、ユーザー名の全バイトサイズを示し、これは最大で 255バイト（28 - 1 バイト）になります。サーバはこの初めの usernamelen バイトを読み、送信者のユーザー名を特定します。その後のバイトは送信される実際のメッセージです。この情報はサーバとクライアントによって自由に使用され、ユーザー名の表示や保存が可能です。

バイトデータは UTF-8 でエンコードおよびデコードされます。これは、1 文字が 1 から 4 バイトで表現される意味です。Python の str.encode と str.decode メソッドは、デフォルトでこの挙動を持っています。

サーバにはリレーシステムが組み込まれており、現在接続中のすべてのクライアントの情報を一時的にメモリ上に保存します。新しいメッセージがサーバに届くと、そのメッセージは現在接続中の全クライアントにリレーされます。

クライアントは、何回か連続で失敗するか、しばらくメッセージを送信していない場合、自動的にリレーシステムから削除されます。この点で TCP と異なり、UDP はコネクションレスであるため、各クライアントの最後のメッセージ送信時刻を追跡する必要があります。
